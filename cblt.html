<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Line Bisection Test</title>
<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    background: #f4f4f4;
    padding-top: 20px;
}
#researcherForm {
    margin-bottom: 20px;
    background: white;
    padding: 15px;
    border: 1px solid #ccc;
}
#researcherForm input {
    margin: 5px;
}
#canvas {
    border: 1px solid black;
    touch-action: none;
    background: white;
    display: none;
}
#errors {
    margin-top: 50px; /* push errors down */
    width: 90%;
    max-width: 600px;
    text-align: left;
    overflow-y: scroll;
    max-height: 200px;
    background: white;
    padding: 10px;
    border: 1px solid #ccc;
    display: none;
}
#finalStats {
    margin-top: 20px;
    font-weight: normal;
    display: none;
}
#userForm {
    display: none;
    margin-top: 20px;
    background: white;
    padding: 15px;
    border: 1px solid #ccc;
}
#userForm input {
    margin: 5px;
}
</style>
</head>
<body>

<h1>Line Bisection Test</h1>

<div id="researcherForm">
    <p><b>Enter number of lines for this test:</b></p>
    <input type="number" id="numLines" placeholder="Number of lines" required>
    <button id="startTest">Start Test</button>
</div>

<canvas id="canvas"></canvas>
<div id="errors"></div>
<div id="finalStats"></div>

<div id="userForm">
    <p><b>Please enter participant information before downloading results:</b></p>
    <input type="text" id="name" placeholder="Name" required>
    <input type="text" id="surname" placeholder="Surname" required>
    <input type="number" id="age" placeholder="Age" required>
    <input type="number" id="duration" placeholder="Years with Parkinson's" required>
    <br>
    <button id="submitInfo">Download CSV</button>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let lineLength = 0;
let startX = 0;
let startY = 0;
let trueMidpointX = 0;

let totalDraws = 100;
let drawCount = 0;
let errors = [];

let userLine = null;
let drawing = false;
let stats = {};

// NEW FLAG — Prevent drawing after test is done
let testFinished = false;

// Responsive canvas
function resizeCanvas() {
    canvas.width = Math.min(window.innerWidth * 0.9, 900);
    canvas.height = Math.min(window.innerHeight * 0.65, 650);
    if(drawCount < totalDraws) drawLine();
}
window.addEventListener("resize", resizeCanvas);

// Draw horizontal line
function drawLine() {
    if (testFinished) return;

    lineLength = canvas.width / 2;
    startX = Math.random() * (canvas.width - lineLength);
    const minY = canvas.height * 0.05;
    const maxY = canvas.height * 0.95;
    startY = minY + Math.random() * (maxY - minY);
    trueMidpointX = startX + lineLength / 2;
    drawCanvas();
}

// Draw all canvas content
function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(startX + lineLength, startY);
    ctx.lineWidth = 5;
    ctx.strokeStyle = "black";
    ctx.stroke();

    if (userLine) {
        ctx.beginPath();
        ctx.moveTo(userLine.x1, userLine.y1);
        ctx.lineTo(userLine.x2, userLine.y2);
        ctx.lineWidth = 3;
        ctx.strokeStyle = "blue";
        ctx.stroke();
    }
}

function getCoords(clientX, clientY) {
    const rect = canvas.getBoundingClientRect();
    return { x: clientX - rect.left, y: clientY - rect.top };
}

// Start drawing
function startDraw(x, y) {
    if (testFinished) return; // ← BLOCK DRAWING

    drawing = true;
    userLine = { x1: x, y1: y, x2: x, y2: y };
    drawCanvas();
}

function moveDraw(x, y) {
    if (!drawing || testFinished) return; // ← BLOCK DRAWING

    userLine.x2 = x;
    userLine.y2 = y;
    drawCanvas();
}

function endDraw(x, y) {
    if (!drawing || testFinished) return; // ← BLOCK DRAWING

    drawing = false;

    const slope = (userLine.y2 - userLine.y1) /
                 (userLine.x2 - userLine.x1 || 0.0001);

    const intersectionX = userLine.x1 + (startY - userLine.y1) / slope;

    const tolerance = 20;
    if (intersectionX < startX - tolerance ||
        intersectionX > startX + lineLength + tolerance) {
        userLine = null;
        drawCanvas();
        return;
    }

    const error = intersectionX - trueMidpointX;
    const percentageError = (error / (lineLength / 2)) * 100;
    const clamped = Math.max(-100, Math.min(100, percentageError));

    errors.push(clamped);

    const sign = clamped >= 0 ? "+" : "-";
    const errorsDiv = document.getElementById("errors");
    const lineMsg = document.createElement("p");
    lineMsg.textContent = `Draw ${drawCount + 1}: ${sign}${Math.abs(clamped).toFixed(2)}%`;
    errorsDiv.appendChild(lineMsg);

    drawCount++;
    userLine = null;

    if (drawCount === totalDraws) {
        testFinished = true;     // ← LOCK TEST
        calculateStats();
        document.getElementById("userForm").style.display = "block";
        document.getElementById("finalStats").style.display = "block";
        return;
    }

    drawLine();
}

// Compute statistics
function calculateStats() {
    const negErrors = errors.filter(e => e < 0);
    const posErrors = errors.filter(e => e > 0);

    const negCount = negErrors.length;
    const posCount = posErrors.length;

    const meanAbsError = errors.map(e => Math.abs(e))
                               .reduce((a,b)=>a+b,0) / errors.length;

    const signedAverage = errors.reduce((a,b)=>a+b,0) / errors.length;

    const meanNeg = negCount ? negErrors.reduce((a,b)=>a+b,0)/negCount : 0;
    const meanPos = posCount ? posErrors.reduce((a,b)=>a+b,0)/posCount : 0;

    const closestMark = Math.min(...errors.map(e => Math.abs(e)));
    const biggestMiss = errors.reduce((p,c)=>Math.abs(c)>Math.abs(p)?c:p,0);

    const stdDev = Math.sqrt(errors.map(e => (e - signedAverage)**2).reduce((a,b)=>a+b,0) / errors.length);

    stats = {
        signedAverage,
        meanAbsError,
        meanNeg,
        meanPos,
        negCount,
        posCount,
        closestMark,
        biggestMiss,
        stdDev
    };

    document.getElementById("finalStats").innerHTML = `
        Total Draws: ${totalDraws}<br>
        Negative Errors: ${negCount}<br>
        Positive Errors: ${posCount}<br><br>

        Directional Bias (Signed Average Error): ${signedAverage.toFixed(2)}%<br>
        Overall Accuracy Error (Absolute Average Error): ${meanAbsError.toFixed(2)}%<br>
        Standard Deviation: ${stdDev.toFixed(2)}%<br><br>

        Average of Negative Errors: ${meanNeg.toFixed(2)}%<br>
        Average of Positive Errors: ${meanPos.toFixed(2)}%<br>
        Closest Mark: ${closestMark.toFixed(2)}%<br>
        Biggest Miss: ${biggestMiss.toFixed(2)}%
    `;
}

/* ===== TOUCH ===== */
canvas.addEventListener("touchstart", e=>{
    e.preventDefault();
    const p = getCoords(e.touches[0].clientX, e.touches[0].clientY);
    startDraw(p.x, p.y);
});
canvas.addEventListener("touchmove", e=>{
    e.preventDefault();
    const p = getCoords(e.touches[0].clientX, e.touches[0].clientY);
    moveDraw(p.x, p.y);
});
canvas.addEventListener("touchend", e=>{
    e.preventDefault();
    const p = getCoords(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    endDraw(p.x, p.y);
});

/* ===== MOUSE ===== */
canvas.addEventListener("mousedown", e=>startDraw(e.offsetX, e.offsetY));
canvas.addEventListener("mousemove", e=>moveDraw(e.offsetX, e.offsetY));
canvas.addEventListener("mouseup",   e=>endDraw(e.offsetX, e.offsetY));

/* ===== CSV ===== */
document.getElementById("submitInfo").addEventListener("click", () => {
    const name = document.getElementById("name").value.trim();
    const surname = document.getElementById("surname").value.trim();
    const age = document.getElementById("age").value.trim();
    const duration = document.getElementById("duration").value.trim();

    if (!name || !surname || !age || !duration) {
        alert("Please fill all fields.");
        return;
    }

    let csv = "data:text/csv;charset=utf-8,";

    csv += `Name,${name}\nSurname,${surname}\nAge,${age}\nYears with Parkinson's,${duration}\n\n`;

    csv += "Final Statistics\n";
    csv += `Directional Bias (Signed Average Error),${stats.signedAverage.toFixed(2)}%\n`;
    csv += `Overall Accuracy Error (Absolute Average Error),${stats.meanAbsError.toFixed(2)}%\n`;
    csv += `Standard Deviation,${stats.stdDev.toFixed(2)}%\n`;
    csv += `Negative Errors,${stats.negCount}\n`;
    csv += `Positive Errors,${stats.posCount}\n`;
    csv += `Average Negative Error,${stats.meanNeg.toFixed(2)}%\n`;
    csv += `Average Positive Error,${stats.meanPos.toFixed(2)}%\n`;
    csv += `Closest Mark,${stats.closestMark.toFixed(2)}%\n`;
    csv += `Biggest Miss,${stats.biggestMiss.toFixed(2)}%\n\n`;

    csv += "Draw,Error (%)\n";
    errors.forEach((e,i)=>csv += `${i+1},${e.toFixed(2)}\n`);

    const uri = encodeURI(csv);
    const link = document.createElement("a");
    const fileName = `Test_${surname}_${age}_${duration}.csv`;
    link.setAttribute("href", uri);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

/* ===== START TEST ===== */
document.getElementById("startTest").addEventListener("click", () => {
    const n = parseInt(document.getElementById("numLines").value);
    if (!n || n <= 0) {
        alert("Please enter a valid number of lines.");
        return;
    }
    totalDraws = n;

    document.getElementById("researcherForm").style.display = "none";
    canvas.style.display = "block";
    document.getElementById("errors").style.display = "block";
    document.getElementById("finalStats").style.display = "block";

    resizeCanvas();
});
</script>
</body>
</html>
